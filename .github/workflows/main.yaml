name: Build and test
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  package:
    name: Build package
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: "latest"
          activate-environment: build-conda-token
          environment-file: etc/build-environment.yml
          python-version: 3.8
          auto-activate-base: false
      - name: Conda Build
        shell: bash -l {0}
        run: |
          conda build conda.recipe --no-test
          mv $CONDA_PREFIX/conda-bld .
  test:
    name: Test (Conda ${{ matrix.conda-version }}, Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        python-version: [2.7, 3.5, 3.6, 3.7, 3.8, 3.9, "3.10"]
        conda-version: [4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9, "4.10", "4.11", "4.12"]
        exclude:
          # Python 2.7
          - python-version: 2.7
            conda-version: 4.8
          - python-version: 2.7
            conda-version: 4.9
          - python-version: 2.7
            conda-version: "4.10"
          - python-version: 2.7
            conda-version: "4.11"
          - python-version: 2.7
            conda-version: "4.12"

          # Python 3.5
          - python-version: 3.5
            conda-version: 4.5
          - python-version: 3.5
            conda-version: 4.6
          - python-version: 3.5
            conda-version: 4.7
          - python-version: 3.5
            conda-version: 4.8
          - python-version: 3.5
            conda-version: 4.9
          - python-version: 3.5
            conda-version: "4.10"
          - python-version: 3.5
            conda-version: "4.11"
          - python-version: 3.5
            conda-version: "4.12"

          # Python 3.7
          - python-version: 3.7
            conda-version: 4.3
          - python-version: 3.7
            conda-version: 4.4

          # Python 3.8
          - python-version: 3.8
            conda-version: 4.3
          - python-version: 3.8
            conda-version: 4.4
          - python-version: 3.8
            conda-version: 4.5
          - python-version: 3.8
            conda-version: 4.6
          - python-version: 3.8
            conda-version: 4.7

          # Python 3.9
          - conda-version: 4.3
            python-version: 3.9
          - conda-version: 4.4
            python-version: 3.9
          - conda-version: 4.5
            python-version: 3.9
          - conda-version: 4.6
            python-version: 3.9
          - conda-version: 4.7
            python-version: 3.9
          - conda-version: 4.8
            python-version: 3.9

          # Python 3.10
          - conda-version: 4.3
            python-version: "3.10"
          - conda-version: 4.4
            python-version: "3.10"
          - conda-version: 4.5
            python-version: "3.10"
          - conda-version: 4.6
            python-version: "3.10"
          - conda-version: 4.7
            python-version: "3.10"
          - conda-version: 4.8
            python-version: "3.10"
          - conda-version: 4.9
            python-version: "3.10"
          - conda-version: "4.11"
            python-version: "3.10"
    steps:
      - uses: actions/checkout@v2
      - name: Download conda standalone
        shell: bash
        run: |
          if [ $RUNNER_OS == 'Linux' ]; then
            curl https://repo.anaconda.com/pkgs/misc/conda-execs/conda-latest-linux-64.exe -o conda.exe
          elif [ $RUNNER_OS == 'Windows' ]; then
            curl https://repo.anaconda.com/pkgs/misc/conda-execs/conda-latest-win-64.exe -o conda.exe
          elif [ $RUNNER_OS == 'macOS' ]; then
            curl https://repo.anaconda.com/pkgs/misc/conda-execs/conda-latest-osx-64.exe -o conda.exe
          fi
          chmod +x conda.exe
          ./conda.exe config --set auto_update_conda false
          ./conda.exe info
      - name: Setup miniconda 
        shell: bash
        run: |
          ./conda.exe create -p $HOME/miniconda conda=${{ matrix.conda-version }} python=${{ matrix.python-version }} 
      - name: py.test
        env:
          CE_TOKEN: ${{ secrets.CE_TOKEN }}
        shell: bash
        run: |
          if [ $RUNNER_OS == 'Windows' ]; then
            source $HOME/miniconda/Scripts/activate root && conda env update -f etc/test-environment.yml -n root -y && conda --version && py.test -xv
          else
            source $HOME/miniconda/bin/activate root && conda env update -f etc/test-environment.yml -n root -y && conda --version && py.test -xv
          fi
#     - name: Codecov
#       uses: codecov/codecov-action@v1
#       with:
#         file: ./cov.xml
#         env_vars: OS,PYTHON